<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>PWA Studio Pro – Build • Analyze • Deploy</title>
  <meta name="description" content="PWA Studio Pro ist das ultimative Tool zum Erstellen, Analysieren und Bereitstellen von Progressive Web Apps. Inklusive Manifest-, Service-Worker-, Supabase- und Deployment-Generator.">
  <meta name="keywords" content="PWA, Progressive Web App, Generator, Service Worker, Manifest, Supabase, GitHub Pages, Deployment, Analyzer, Checker, Builder">
  <meta property="og:title" content="PWA Studio Pro – Build • Analyze • Deploy">
  <meta property="og:description" content="Das All-in-One PWA Toolkit: Erstelle, analysiere und veröffentliche Progressive Web Apps mit nur wenigen Klicks.">
  <meta property="og:type" content="website">
  <meta name="author" content="Björn Voss aka Omega">

  <meta name="theme-color" content="#1e40af" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#111827" media="(prefers-color-scheme: dark)">
  <style>
    /* ... (alle CSS-Stile bleiben unverändert) ... */
    :root {
      --primary-color: #3b82f6; --background-color: #f1f5f9; --text-color: #1f2937;
      --card-background: #ffffff; --header-gradient: linear-gradient(135deg, #1e40af, #1d4ed8);
      --input-bg: #f9fafb; --border-color: #d1d5db; --subtle-text: #6b7280;
      --success-bg: #f0fff4; --success-border: #38a169; --success-text: #2f855a;
    }
    html.dark {
      --background-color: #111827; --text-color: #d1d5db; --card-background: #1f2937;
      --input-bg: #374151; --border-color: #4b5563; --subtle-text: #9ca3af;
      --success-bg: #1a3627; --success-border: #48bb78; --success-text: #9ae6b4;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%; max-width: 100%; overflow-x: hidden;
      background: var(--background-color); color: var(--text-color);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      transition: background-color 0.3s, color 0.3s;
      -webkit-text-size-adjust: 100%;
      display: flex; flex-direction: column; min-height: 100vh;
      scroll-behavior: smooth;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    input, textarea, code,
    #supabaseSuggestionContainer .table-name-display code,
    #supabaseSuggestionContainer table code,
    #supabaseSuggestionContainer button#copySqlButton,
    .correction-box textarea,
    #supabaseCodeSnippets pre code {
        user-select: text;
       -webkit-user-select: text;
       -moz-user-select: text;
       -ms-user-select: text;
    }

    header {
      background: var(--header-gradient);
      color: white; text-align: center; padding: 1rem;
      font-size: 1.2rem;
      font-weight: 700; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      display: flex; align-items: center; justify-content: space-between;
      position: relative; transition: background 0.3s;
      min-height: 70px;
    }
    .header-title-container {
        flex-grow: 1;
        text-align: center;
        padding: 0 10px;
        line-height: 1.3;
    }
    .header-title-container .main-title {
        font-size: 1.3rem;
        display: block;
    }
     .header-title-container .subtitle {
        font-size: 0.85rem;
        font-weight: 400;
        opacity: 0.9;
        display: block;
        margin-top: 2px;
     }

    main { flex: 1; padding: 1rem; width: 100%; max-width: 800px; margin: 0 auto; }
    .card {
      background: var(--card-background); border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      padding: 1.5rem; margin-bottom: 1.5rem; width: 100%;
      transition: background-color 0.3s;
    }
    .output-card {
        background: #f8f8f8; box-shadow: none !important; padding: 1rem;
        border-radius: 8px; margin-top: 15px; border: 1px solid var(--border-color);
    }
    html.dark .output-card { background: #1f2937; }
    label { display: flex; align-items: center; margin-top: 12px; font-weight: 600; font-size: 0.95rem; }
    input, select, textarea {
      width: 100%; display: block; padding: 12px; margin-top: 5px;
      border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem;
      background: var(--input-bg);
      color: inherit;
    }
    input[type="color"] { padding: 5px; height: 50px; cursor: pointer; }
    input:focus, select:focus, textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); outline: none; }
    button:not(.tab-button):not(.fab) {
      display: block; width: 100%; background: var(--primary-color); color: white;
      padding: 14px; border: none; border-radius: 8px; font-size: 1.1rem;
      margin-top: 1rem; cursor: pointer; transition: all 0.2s;
      box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
    }
    button:disabled { background: #9ca3af; box-shadow: none; cursor: not-allowed; }
    .copy-btn { background: #10b981; margin-top: 0.8rem; }
    .copy-snippet-btn { /* Bleibt drin, falls man es doch mal braucht */
        background: #6b7280;
        margin-top: 0.5rem;
        width: auto;
        padding: 8px 12px;
        font-size: 0.9rem;
        box-shadow: none;
        float: right;
        margin-bottom: 5px;
    }

    .action-group { display: flex; gap: 10px; margin-top: 1rem; flex-wrap: wrap; }
    .action-group button { flex-grow: 1; margin: 0; padding: 12px; font-size: 0.95rem; }

    .tabs-container {
      display: flex; margin-bottom: 1.5rem; background: var(--card-background);
      border-radius: 12px; padding: 5px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid var(--border-color);
      scrollbar-width: none; position: relative;
    }
    .tabs-container::-webkit-scrollbar { display: none; }

    .scroll-indicator {
        position: absolute; top: 50%; right: 8px; transform: translateY(-50%);
        width: 24px; height: 24px; background-color: rgba(59, 130, 246, 0.1);
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        pointer-events: none; opacity: 0; transition: opacity 0.3s;
        animation: pulse 2s infinite;
    }
    .scroll-indicator.visible { opacity: 1; }
    .scroll-indicator svg { stroke: var(--primary-color); }
    @keyframes pulse { 0%, 100% { transform: translateY(-50%) scale(1); } 50% { transform: translateY(-50%) scale(1.1); } }

    .tab-button {
      flex-shrink: 0; padding: 10px 15px; text-align: center; border: none; background: transparent;
      font-weight: 600; color: var(--subtle-text); cursor: pointer; border-radius: 8px;
      transition: all 0.2s; min-width: 105px; margin: 2px 4px;
    }
    .tab-button.active { background: var(--primary-color); color: white; box-shadow: 0 2px 6px rgba(59, 130, 246, 0.5); transform: translateY(-1px); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .analysis-result { background: #ecfdf5; border: 1px solid #a7f3d0; padding: 1rem; border-radius: 8px; margin-top: 1rem; }
    html.dark .analysis-result { background: #064e3b; border-color: #059669; }
    .correction-box { background: #fffbeb; border: 1px solid #fcd34d; padding: 1rem; border-radius: 8px; margin-top: 1rem;}
    html.dark .correction-box { background: #422006; border-color: #d97706;}
    .ok { color: #10b981; } .fail { color: #ef4444; }

    footer { background-color: #1f2937; color: #d1d5db; text-align: center; padding: 1.5rem; font-size: 0.75rem; margin-top: auto; }
    footer p { margin-bottom: 0.25rem; }
    footer a { color: #3b82f6; text-decoration: none; }
    .fab#downloadButton {
        display: none;
        position: fixed; bottom: 20px; right: 20px; background: #ef4444; color: white;
        width: 65px; height: 65px; font-size: 2rem; border: none; border-radius: 50%;
        box-shadow: 0 10px 20px rgba(239, 68, 68, 0.4); cursor: pointer; animation: fadeIn 0.5s;
        z-index: 999;
        display: flex; align-items: center; justify-content: center;
        padding: 0;
        line-height: 1;
    }


    #iconPreview { display: block; margin: 15px auto 0; width: 64px; height: 64px; border-radius: 12px; object-fit: cover; }
    #networkStatus { position: fixed; top: 0; left: 0; width: 100%; padding: 5px; text-align: center; font-size: 0.8rem; z-index: 1000; transform: translateY(-100%); transition: transform 0.3s; }
    .status-online { background: #d1fae5; color: #065f46; transform: translateY(0); }
    .status-offline { background: #fee2e2; color: #991b1b; transform: translateY(0); }
    code { background-color: #e5e7eb; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
    html.dark code { background-color: #374151; }
    pre {
      background-color: #e5e7eb;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      margin-top: 1rem;
      border: 1px solid var(--border-color);
      clear: both;
    }
    html.dark pre { background-color: #374151; }
    pre code { background: transparent; padding: 0; }


    .option-group { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
    .option-group:first-child { margin-top: 0; padding-top: 0; border-top: none; }
    .option-group h3, #tutorial .option-group h3 {
      display: flex; align-items: center; margin-bottom: 10px; font-size: 1.1rem;
      border-bottom: 2px solid var(--primary-color); padding-bottom: 5px;
      color: #1e40af;
    }
     html.dark .option-group h3, html.dark #tutorial .option-group h3 {
        color: var(--primary-color);
     }
    .option-group h4 {
        margin-top: 1.5rem; font-size: 1.1rem;
    }
     .option-group p {
        margin-bottom: 0.5rem;
        line-height: 1.6;
    }
     .option-group ol, .option-group ul {
        margin-top: 10px; margin-left: 25px;
    }
     .option-group li {
         margin-bottom: 5px;
    }

    .radio-group { display: flex; gap: 20px; margin-top: 10px; }
    .radio-group label { margin-top: 0; font-weight: normal; }
    .radio-group input { margin-right: 5px; width: auto; }
    .shortcut-entry { margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem; }
    .shortcut-entry:first-child { margin-top: 0; border-top: none; padding-top: 0; }
    html.dark .shortcut-entry { border-top-color: #374151; }

    .info-icon {
        display: inline-block; width: 20px; height: 20px;
        background-color: #d1d5db; color: white; border-radius: 50%;
        text-align: center; font-weight: bold; font-style: italic;
        font-family: serif; line-height: 20px; cursor: pointer; margin-left: auto;
        font-size: 0.8rem; flex-shrink: 0;
    }
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 1000;
        display: none; align-items: center; justify-content: center;
        padding: 1rem;
    }
    .modal-content {
        background: white; padding: 1.5rem; border-radius: 12px;
        max-width: 500px; width: 100%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        animation: fadeIn 0.3s;
    }
    html.dark .modal-content { background: var(--card-background); }
    .modal-content h3 { color: #1e40af; }
    html.dark .modal-content h3 { color: var(--primary-color); }
    .modal-content p { color: #4b5563; line-height: 1.6; }
    html.dark .modal-content p { color: var(--text-color); }
    .modal-content button { margin-top: 1.5rem; background: #6b7280; box-shadow: none; }

    #darkModeToggle {
        background: rgba(255,255,255,0.2); border: none; border-radius: 50%;
        width: 40px; height: 40px; cursor: pointer; padding: 8px;
        box-shadow: none; margin: 0; font-size: 1.2rem;
        line-height: 1; display: flex; align-items: center; justify-content: center;
        flex-shrink: 0;
    }
    #darkModeToggle svg { display: none; }

    #supabaseSuggestionContainer {
        border-left: 4px solid var(--success-border);
        background: var(--success-bg);
        color: var(--success-text);
        padding: 1.5rem;
        border-radius: 8px;
    }
    #supabaseSuggestionContainer h4, #supabaseSuggestionContainer h4 svg { color: var(--success-text); stroke: var(--success-text); }
    #supabaseSuggestionContainer p, #supabaseSuggestionContainer ul, #supabaseSuggestionContainer li { color: var(--text-color); }
    html.dark #supabaseSuggestionContainer p, html.dark #supabaseSuggestionContainer ul, html.dark #supabaseSuggestionContainer li { color: #d1d5db; }
    #supabaseSuggestionContainer .table-name-display {
        background-color: rgba(255, 255, 255, 0.5);
        padding: 5px 10px;
        border-radius: 4px;
        margin-top: 8px;
        display: block;
        overflow-wrap: break-word;
        word-break: break-all;
    }
    html.dark #supabaseSuggestionContainer .table-name-display {
         background-color: rgba(0, 0, 0, 0.3);
    }
    #supabaseCodeSnippets { /* Wird nicht mehr verwendet, CSS kann drin bleiben */
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px dashed var(--success-border);
    }
    #supabaseCodeSnippets h5 {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        color: var(--success-text);
    }


    /* WIZARD Stile */
    .wizard-step { display: none; }
    .wizard-step.active { display: block; animation: fadeIn 0.5s; }
    #wizard-progress-bar { width: 100%; height: 8px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden; margin-bottom: 1.5rem;}
    #wizard-progress { width: 25%; height: 100%; background-color: var(--primary-color); transition: width 0.3s; }
    .wizard-nav { display: flex; justify-content: space-between; gap: 10px; margin-top: 1.5rem; }
    .wizard-nav button { flex-grow: 1; margin: 0; }
    .wizard-nav .prev-btn { background-color: #6b7280; }

    /* CHECKER Stile */
    #checkResults li { list-style: none; margin-bottom: 10px; font-weight: 500; }
    #checkResults .spinner { display: inline-block; width: 1em; height: 1em; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;}
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

    <script>
      //--- Dieses Skript setzt den Manifest-Pfad für das *PWA Studio selbst* ---
      (function() {
          const pathSegments = window.location.pathname.split('/');
          if (pathSegments[pathSegments.length - 1].includes('.')) {
              pathSegments.pop();
          }
          let basePath = pathSegments.join('/');
          if (!basePath.endsWith('/')) {
              basePath += '/';
          }
          if (basePath === '//') {
              basePath = '/';
          }
          const manifestLink = document.createElement('link');
          manifestLink.rel = 'manifest';
          manifestLink.href = basePath + 'manifest.json'; 
          document.head.appendChild(manifestLink);
      })();
    </script>
<style>body{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}</style>
<style>input, textarea, code { user-select: text !important; -webkit-user-select: text !important; -moz-user-select: text !important; -ms-user-select: text !important; }</style>
</head>
<body>
  <div id="networkStatus"></div>
  <header>
    <div class="header-title-container">
        <span class="main-title">✨ PWA Studio Pro</span>
        <span class="subtitle">Build • Analyze • Deploy</span>
    </div>
    <button id="darkModeToggle" aria-label="Theme wechseln">🌗</button>
  </header>
  <main>
    <div class="tabs-container">
      <button class="tab-button active" data-tab="tutorial">1. 📖 Anleitung & Deployment</button>
      <button class="tab-button" data-tab="analyze">2. 🔍 Analysieren</button>
      <button class="tab-button" data-tab="generate">3. ⚙️ Generieren</button>
      <button class="tab-button" data-tab="check">4. ✅ Prüfen</button>
      <div class="scroll-indicator">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 18L15 12L9 6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>

    <div id="tutorial" class="tab-content card active">
        <h2>📖 Anleitung: Von der Idee zur fertigen PWA</h2>
        <div class="option-group">
            <h3>Schritt 1: Projekt vorbereiten & Analysieren</h3>
            <p>Jede PWA startet mit einer HTML-Datei. Im Tab <strong>"2. 🔍 Analysieren"</strong> können Sie eine bestehende Datei hochladen, eine unserer Start-Vorlagen nutzen oder den Code direkt einfügen. Das Tool prüft die Datei, ergänzt fehlende PWA-Tags und kann sogar basierend auf Ihren Eingabefeldern eine passende Datenbank-Tabelle für Supabase vorschlagen.</p>
        </div>
        <div class="option-group">
            <h3>Schritt 2: PWA konfigurieren & generieren</h3>
            <p>Im Tab <strong>"3. ⚙️ Generieren"</strong> erwecken Sie Ihre App zum Leben. Ein Assistent führt Sie Schritt für Schritt durch die Konfiguration: Name, Icon, Farben, Caching-Verhalten und erweiterte Funktionen.</p>
        </div>
        <div class="option-group">
            <h3>Schritt 3: Download & Veröffentlichung mit GitHub</h3>
            <p>Nach der Generierung erscheint der rote <strong>Download-Button (⬇️)</strong>. Das resultierende ZIP-Archiv enthält alles, was Sie für die Veröffentlichung benötigen.</p>
            <h4>Standard-Deployment (ohne Supabase)</h4>
            <ol>
                <li>Erstellen Sie ein neues, öffentliches Repository auf GitHub.</li>
                <li>Laden Sie alle Dateien aus dem ZIP-Archiv (außer dem <code>.github</code>-Ordner) in dieses Repository hoch.</li>
                <li>Gehen Sie in den Repository-Einstellungen zu <strong>Settings > Pages</strong>.</li>
                <li>Wählen Sie als Quelle <strong>Deploy from a branch</strong>, als Branch <strong>main</strong> und als Ordner <strong>/ (root)</strong>. Speichern Sie.</li>
                <li>Nach 1-2 Minuten ist Ihre PWA unter der angezeigten URL erreichbar.</li>
            </ol>
            <h4>Deployment mit Supabase & GitHub Secrets (Sicher)</h4>
            <p>Wählen Sie diesen Weg, wenn Sie im Assistenten "Supabase" aktiviert haben.</p>
            <ol>
                <li><strong>Supabase-Projekt:</strong> Kopieren Sie Ihre <strong>Project URL</strong> und den <strong><code>anon / public</code> Key</strong> aus Ihren Supabase API-Einstellungen.</li>
                <li><strong>GitHub Secrets:</strong> Erstellen Sie in Ihrem GitHub Repository unter <strong>Settings > Secrets and variables > Actions</strong> zwei Secrets: <code>SUPABASE_URL</code> und <code>SUPABASE_ANON_KEY</code> mit den Werten aus Schritt 1.</li>
                <li><strong>Dateien hochladen:</strong> Laden Sie den **gesamten Inhalt** des ZIP-Archivs (inklusive des <code>.github</code>-Ordners) in Ihr Repo (Branch: <strong>main</strong>) hoch.</li>
                <li><strong>GitHub Pages aktivieren:</strong> Der Upload startet automatisch den Deployment-Prozess (die "Action"). Gehen Sie danach zu <strong>Settings > Pages</strong>, wählen Sie als Quelle <strong>Deploy from a branch</strong>, als Branch <strong>gh-pages</strong> (wichtig: *nicht* main!) und als Ordner <strong>/ (root)</strong>. Speichern Sie.</li>
            </ol>
        </div>
         <div class="option-group">
             <h3>Das Studio selbst bearbeiten & online stellen ("Meta-Workflow")</h3>
            <p>Sie können diese App benutzen, um sich selbst zu bearbeiten und als PWA auf ihrem eigenen GitHub zu hosten.</p>
            <ol>
                <li><strong>Code kopieren:</strong> Gehen Sie in die Entwickler-Tools Ihres Browsers, finden Sie das <code>&lt;html&gt;</code>-Element, klicken Sie rechts darauf und wählen Sie "OuterHTML kopieren".</li>
                <li><strong>Code einfügen:</strong> Fügen Sie den kompletten Code in den Editor im Tab <strong>"2. 🔍 Analysieren"</strong> ein und klicken Sie auf "Analysieren".</li>
                <li><strong>Konfigurieren & Generieren:</strong> Gehen Sie zu Tab 3. Geben Sie <strong>Ihren GitHub-Benutzernamen</strong> und einen neuen Repository-Namen für das Studio an. Aktivieren Sie alle gewünschten Features.</li>
                <li><strong>Download & Deployment:</strong> Laden Sie das ZIP herunter und folgen Sie der normalen Deployment-Anleitung oben.</li>
            </ol>
            <div class="correction-box" style="padding: 1rem; margin-top: 1rem;">
                <h5 style="color: #d97706; margin-bottom: 5px;">⚠️ Wichtiger Hinweis (Meta-Workflow)</h5>
                <p style="font-size: 0.9rem; line-height: 1.5;">Nachdem Sie Ihr eigenes PWA Studio veröffentlicht haben, müssen Sie möglicherweise den <strong>Cache Ihres Browsers für die *ursprüngliche* Studio-Seite (diese hier) leeren</strong>, um Ihre neue Version korrekt zu sehen und zu nutzen. Ansonsten lädt der Browser eventuell weiterhin die alte Version aus dem Cache.</p>
            </div>
            </div>
        <div class="option-group">
            <h3>Schritt 4: PWA live prüfen</h3>
            <p>Sobald Ihre App online ist, können Sie im Tab <strong>"4. ✅ Prüfen"</strong> die URL eingeben, um zu testen, ob grundlegende PWA-Anforderungen wie ein Manifest und ein Service Worker vorhanden sind.</p>
        </div>
        <div class="option-group">
            <h3><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                Troubleshooting & Updates
            </h3>
            <h4>Updates für Ihre PWA funktionieren nicht?</h4>
            <p>Wenn Sie Änderungen an Ihrer PWA vornehmen (z.B. den Inhalt ändern), diese hochladen, aber Nutzer die alte Version sehen, liegt das fast immer am Caching.</p>
            <p><strong>Die Lösung:</strong> Erhöhen Sie die <strong>Cache-Version</strong> im Tab <strong>"3. ⚙️ Generieren"</strong> (z.B. von <code>v1</code> auf <code>v2</code>), bevor Sie die PWA-Dateien generieren. </p>
            <ul>
                <li>Dies zwingt den Service Worker, alle Dateien neu herunterzuladen.</li>
                <li>Nur die <code>sw.js</code>-Datei zu ändern, reicht oft nicht aus, da der Browser die <code>sw.js</code> selbst cachen kann. Die Änderung der Version im Dateinamen (<code>pwa-cache-v2</code>) ist der zuverlässigste Weg.</li>
            </ul>
        </div>
        </div>
<div id="analyze" class="tab-content card">
  <h2>🔬 HTML-Analyse & Korrektur</h2>
    <div class="option-group">
        <h3>PWA-Starter-Vorlagen</h3>
        <p style="font-size:0.8rem; color: var(--subtle-text); margin-bottom: 10px;">Beginnen Sie ein neues Projekt mit einer fertigen Vorlage.</p>
        <div class="action-group">
            <button id="templateMinimal">Minimal PWA</button>
            <button id="templateTodo">Todo-App Vorlage</button>
        </div>
    </div>
    <div class="option-group">
        <h3>Eigene HTML-Datei</h3>
        <p>Laden Sie Ihre <code>index.html</code> hoch oder fügen Sie den Code in das Feld unten ein.</p>
        <input type="file" id="fileInput" accept=".html,.htm">
        <textarea id="htmlInput" rows="8" placeholder="... oder fügen Sie hier Ihren HTML-Code ein"></textarea>
        <button id="analyzeButton">🔍 HTML prüfen & korrigieren</button>
    </div>
    <div id="analysisOutput" class="analysis-result" style="display: none; margin-top: 1.5rem;"></div>
    <div id="correctionContainer" class="correction-box" style="display: none; margin-top: 1.5rem;">
        <h4>✅ Korrigierter HTML-Code (PWA Ready)</h4>
        <textarea id="correctedHtmlOutput" rows="10" readonly></textarea>
        <button class="copy-btn" id="copyButton">📋 Korrigierten Code kopieren</button>
    </div>
    <div id="supabaseSuggestionContainer" class="card" style="display: none; margin-top: 1.5rem;">
        </div>
</div>

<div id="generate" class="tab-content card">
  <h2>⚙️ PWA-Assistent</h2>
  <div id="wizard-progress-bar"><div id="wizard-progress"></div></div>

  <div id="wizard-step-1" class="wizard-step active">
    <div class="option-group">
      <h3>Schritt 1/4: Basis-Infos <span class="info-icon" data-info-key="basis">i</span></h3>
      <label for="githubUser">GitHub Benutzername:</label> <input id="githubUser" type="text" placeholder="z.B. user-name">
      <label for="repoName">Repository-Name:</label> <input id="repoName" type="text" placeholder="z.B. my-awesome-pwa">
      <label for="appName">App-Name (Voll):</label> <input id="appName" type="text" value="Meine PWA App">
      <label for="appShortName">App-Kurzname (Startbildschirm):</label> <input id="appShortName" type="text" value="PWA App">
      <label for="appDesc">Beschreibung:</label> <input id="appDesc" type="text" value="Erstellt mit PWA-Studio Pro.">
    </div>
  </div>

  <div id="wizard-step-2" class="wizard-step">
      <div class="option-group">
        <h3>Schritt 2/4: Design & Icon <span class="info-icon" data-info-key="design">i</span></h3>
        <label for="themeColor">Theme-Farbe (ändert den Header als Vorschau)</label>
        <input id="themeColor" type="color" value="#1e40af">
      </div>
      <div class="option-group">
        <h3>App Icon <span class="info-icon" data-info-key="icon">i</span></h3>
        <label for="iconUpload">Icon-Datei hochladen:</label>
        <input type="file" id="iconUpload" accept="image/png, image/jpeg">
        <div style="text-align: center; margin: 10px 0;">oder</div>
        <label for="iconInitials">Einfacher Icon-Generator:</label>
        <input type="text" id="iconInitials" placeholder="Initialen (z.B. AB)" maxlength="2">
        <label for="iconBgColor">Hintergrundfarbe:</label>
        <input type="color" id="iconBgColor" value="#3b82f6">
        <button id="generateIconButton" style="margin-top:10px; font-size: 0.9rem; padding: 10px;">Icon generieren</button>
        <img id="iconPreview" style="display:none;" alt="Icon Vorschau">
        <label style="margin-top: 1rem;"><input type="checkbox" id="generateMaskableIcon" style="width: auto; margin-right: 10px;">Maskable Icon generieren? <span class="info-icon" data-info-key="maskable">i</span></label>
      </div>
  </div>

  <div id="wizard-step-3" class="wizard-step">
    <div class="option-group">
      <h3>Schritt 3/4: Offline-Verhalten <span class="info-icon" data-info-key="caching">i</span></h3>
      <label for="swStrategy">Strategie</label>
      <select id="swStrategy">
          <option value="cache-first">Cache First (Standard & Schnell)</option>
          <option value="network-first">Network First (Aktuelle Daten)</option>
      </select>
      <label for="cacheVersion">Cache-Version:</label> <input id="cacheVersion" type="text" value="v1">
      <label for="extraFiles">Zusätzliche Dateien zum Cachen (automatisch erkannt):</label> <input id="extraFiles" type="text" placeholder="z. B. style.css, app.js">
    </div>
    <div class="option-group">
      <h3>App-Optionen <span class="info-icon" data-info-key="appOptions">i</span></h3>
      <div class="radio-group">
          <label><input type="radio" name="userSelect" value="enabled"> Text wählbar</label>
          <label><input type="radio" name="userSelect" value="disabled" checked> Text nicht wählbar</label>
      </div>
      <label style="margin-top: 20px;"><input type="checkbox" id="generateFooter" style="width: auto; margin-right: 10px;"> Footer in App einfügen?</label>
      <div id="footerFields" style="display: none;">
          <label for="footerLine1">Footer Zeile 1:</label> <input id="footerLine1" type="text" value="PWA Studio App">
          <label for="footerLine2">Footer Zeile 2:</label> <input id="footerLine2" type="text" value="Entwickler: Björn Voss aka Omega">
          <label for="footerLine3">Footer Zeile 3:</label> <input id="footerLine3" type="text" value="voss.1980@gmail.com">
      </div>
    </div>
  </div>

  <div id="wizard-step-4" class="wizard-step">
    <div class="option-group">
      <h3>Schritt 4/4: Erweiterte Funktionen (Optional) <span class="info-icon" data-info-key="advanced">i</span></h3>
      <label><input type="checkbox" id="addSupabase" style="width: auto; margin-right: 10px;">🔐 Supabase für GitHub Actions vorbereiten?</label>
      <div id="pushNotificationFields" style="margin-top: 10px;">
          <label><input type="checkbox" id="addPushNotifications" style="width: auto; margin-right: 10px;">🔔 Push-Benachrichtigungen aktivieren?</label>
          <div id="vapidKeyContainer" style="display: none; margin-left: 25px; margin-top: 5px;">
              <label for="vapidKeyInput">VAPID Public Key (optional):</label>
              <input type="text" id="vapidKeyInput" placeholder="Ihr Public VAPID Key">
          </div>
      </div>
      <label style="margin-top: 10px;"><input type="checkbox" id="addBackgroundSync" style="width: auto; margin-right: 10px;">🔄 Hintergrund-Synchronisation aktivieren?</label>
      <label style="margin-top: 10px;"><input type="checkbox" id="addShareTarget" style="width: auto; margin-right: 10px;">🎯 Als Ziel beim Teilen anbieten?</label>
       <div id="shareTargetFields" style="display: none;" class="output-card">
            <h4>Share Target Konfiguration</h4>
            <p style="font-size:0.8rem; color: #6b7280; margin-bottom: 10px;">Legt fest, wie Ihre App geteilte Links/Texte empfängt.</p>
            <label>Aktions-URL (z.B. /receive-share):</label><input type="text" id="shareTargetAction" value="/receive-share">
        </div>
    </div>
    <button id="generateButton">🚀 PWA-Dateien generieren</button>
  </div>

  <div class="wizard-nav">
    <button id="prev-btn" class="prev-btn" style="display: none;">Zurück</button>
    <button id="next-btn" class="next-btn">Weiter</button>
  </div>

  <div id="outputSection" class="card" style="margin-top: 30px; display: none;">
      <h2>📄 Code-Ausgabe</h2>
      <div class="output-card"> <h3>📦 Manifest (manifest.json)</h3> <textarea id="manifestOutput" rows="6" readonly></textarea> </div>
      <div class="output-card"> <h3>⚙️ Service Worker (sw.js)</h3> <textarea id="swOutput" rows="6" readonly></textarea> </div>
  </div>
</div>

<div id="check" class="tab-content card">
    <h2>✅ PWA Live-Prüfung</h2>
    <p style="font-size:0.9rem; color: var(--subtle-text); margin-bottom: 1rem;">Geben Sie die vollständige URL Ihrer veröffentlichten PWA ein, um zu prüfen, ob die wichtigsten Dateien erreichbar sind.</p>
    <label for="pwaUrlInput">PWA-URL:</label>
    <input type="url" id="pwaUrlInput" placeholder="https://user-name.github.io/repo-name/">
    <button id="checkPwaButton">🔍 PWA prüfen</button>
    <div id="checkResults" style="margin-top: 1.5rem;"></div>
</div>

  </main>
  <button class="fab" id="downloadButton">⬇️</button>
  <footer id="appFooter">
<p>PWA Studio Pro © 2025 – Build • Analyze • Deploy</p>
<p>Entwickelt von Björn Voss aka Omega</p>
<p><a href="mailto:voss.1980@gmail.com">voss.1980@gmail.com</a></p>
  </footer>
  <div id="infoModal" class="modal-overlay">
  <div class="modal-content">
      <h3 id="modalTitle"></h3>
      <p id="modalText"></p>
      <button id="modalCloseButton">Schließen</button>
  </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script>
document.addEventListener('DOMContentLoaded', () => {
    // --- pwaArtifacts: Hinzugefügt 'suggestedTableName' & 'detectedColumns' ---
    const pwaArtifacts = { manifest: null, sw: null, html: null, icon192: null, icon512: null, maskableIcon512: null, offlineHtml: null, shareReceiverHtml: null, supabaseClient: null, githubWorkflow: null, appJs: null, suggestedTableName: 'app_data', detectedColumns: [] };
    let uploadedIconBase64 = null;
    let correctedHtmlForZip = null;
    let currentWizardStep = 1;
    const totalWizardSteps = 4;

    const ui = {
        tabsContainer: document.querySelector('.tabs-container'),
        infoModal: document.getElementById('infoModal'),
        modalTitle: document.getElementById('modalTitle'),
        modalText: document.getElementById('modalText'),
        modalCloseButton: document.getElementById('modalCloseButton'),
        fileInput: document.getElementById('fileInput'),
        htmlInput: document.getElementById('htmlInput'),
        analyzeButton: document.getElementById('analyzeButton'),
        analysisOutput: document.getElementById('analysisOutput'),
        correctionContainer: document.getElementById('correctionContainer'),
        correctedHtmlOutput: document.getElementById('correctedHtmlOutput'),
        supabaseSuggestionContainer: document.getElementById('supabaseSuggestionContainer'),
        copyButton: document.getElementById('copyButton'),
        githubUser: document.getElementById('githubUser'),
        repoName: document.getElementById('repoName'),
        appName: document.getElementById('appName'),
        appShortName: document.getElementById('appShortName'),
        appDesc: document.getElementById('appDesc'),
        iconUpload: document.getElementById('iconUpload'),
        iconPreview: document.getElementById('iconPreview'),
        themeColor: document.getElementById('themeColor'),
        swStrategy: document.getElementById('swStrategy'),
        cacheVersion: document.getElementById('cacheVersion'),
        extraFiles: document.getElementById('extraFiles'),
        generateFooter: document.getElementById('generateFooter'),
        footerFields: document.getElementById('footerFields'),
        footerLine1: document.getElementById('footerLine1'),
        footerLine2: document.getElementById('footerLine2'),
        footerLine3: document.getElementById('footerLine3'),
        addSupabase: document.getElementById('addSupabase'),
        addPushNotifications: document.getElementById('addPushNotifications'),
        vapidKeyContainer: document.getElementById('vapidKeyContainer'),
        vapidKeyInput: document.getElementById('vapidKeyInput'),
        addBackgroundSync: document.getElementById('addBackgroundSync'),
        addShareTarget: document.getElementById('addShareTarget'),
        shareTargetFields: document.getElementById('shareTargetFields'),
        shareTargetAction: document.getElementById('shareTargetAction'),
        generateButton: document.getElementById('generateButton'),
        outputSection: document.getElementById('outputSection'),
        manifestOutput: document.getElementById('manifestOutput'),
        swOutput: document.getElementById('swOutput'),
        downloadButton: document.getElementById('downloadButton'),
        networkStatus: document.getElementById('networkStatus'),
        templateMinimal: document.getElementById('templateMinimal'),
        templateTodo: document.getElementById('templateTodo'),
        iconInitials: document.getElementById('iconInitials'),
        iconBgColor: document.getElementById('iconBgColor'),
        generateIconButton: document.getElementById('generateIconButton'),
        generateMaskableIcon: document.getElementById('generateMaskableIcon'),
        darkModeToggle: document.getElementById('darkModeToggle'),
        scrollIndicator: document.querySelector('.scroll-indicator'),
        prevBtn: document.getElementById('prev-btn'),
        nextBtn: document.getElementById('next-btn'),
        wizardProgress: document.getElementById('wizard-progress'),
        pwaUrlInput: document.getElementById('pwaUrlInput'),
        checkPwaButton: document.getElementById('checkPwaButton'),
        checkResults: document.getElementById('checkResults')
    };

    const infoTexts = {
        basis: { title: 'Basis-Infos', text: '<b>GitHub-Name & Repo:</b> Notwendig, um die korrekte Start-URL für Ihre PWA zu generieren.<br><b>App-Namen:</b> Der volle Name erscheint z.B. bei der Installation, der Kurzname auf dem Homescreen.<br><b>Beschreibung:</b> Eine kurze Info über Ihre App.'},
        icon: { title: 'App Icon', text: 'Laden Sie ein quadratisches Bild hoch (mind. 512x512px) oder nutzen Sie den Generator, um ein einfaches Icon mit Initialen zu erstellen. Dieses Icon erscheint auf dem Homescreen.'},
        maskable: { title: 'Maskable Icon', text: 'Ein "maskierbares" Icon stellt sicher, dass Ihr App-Logo auf allen Android-Geräten korrekt angezeigt wird, unabhängig von der vom System verwendeten Icon-Form (rund, quadratisch etc.). Es verhindert unschöne Ränder.' },
        design: { title: 'Design & Verhalten', text: '<b>Theme-Farbe:</b> Legt die Farbe der Adressleiste im Browser fest.<br><b>Shortcuts:</b> Erlaubt Schnellzugriffe, wenn man das App-Icon lange gedrückt hält (z.B. "Neuer Eintrag").'},
        caching: { title: 'Service Worker & Caching', text: '<b>Strategie:</b> Legt fest, wie Ihre App offline funktioniert. "Cache First" ist schneller, "Network First" liefert aktuellere Daten.<br><b>Cache-Version:</b> Ändern Sie dies (z.B. auf "v2"), um bei einem Update einen neuen Cache zu erzwingen.<br><b>Zusätzliche Dateien:</b> Listen Sie hier alle weiteren wichtigen Dateien auf (z.B. <code>style.css</code>), damit diese auch offline verfügbar sind.'},
        appOptions: { title: 'Optionen für generierte App', text: '<b>Text wählbar:</b> Legt fest, ob Nutzer den Text in Ihrer fertigen PWA markieren und kopieren können.<br><br><b>Footer einfügen:</b> Fügt der generierten App einen anpassbaren Footer am unteren Ende der Seite hinzu.' },
        advanced: { title: 'Erweiterte Funktionen', text: '<b>Supabase:</b> Bereitet Ihre App für eine sichere Datenbank-Anbindung vor.<br><b>Push-Benachrichtigungen:</b> Ermöglicht das Senden von Nachrichten an Ihre Nutzer, auch wenn die App geschlossen ist.<br><b>Hintergrund-Sync:</b> Lässt Ihre App Aktionen (z.B. Formular senden) im Hintergrund abschließen, sobald wieder Internet verfügbar ist.<br><b>Share Target:</b> Macht Ihre App im "Teilen"-Menü des Handys verfügbar.'}
    };

    ui.downloadButton.style.display = 'none';

    function showInfoModal(key, event) {
        event.preventDefault();
        event.stopPropagation();
        const info = infoTexts[key];
        if (info) {
            ui.modalTitle.innerHTML = info.title;
            ui.modalText.innerHTML = info.text;
            ui.infoModal.style.display = 'flex';
        }
    }
    document.querySelectorAll('.info-icon').forEach(icon => {
        const key = icon.dataset.infoKey;
        if(key && infoTexts[key]) {
             icon.addEventListener('click', (e) => showInfoModal(key, e));
        }
    });

    function hideInfoModal() { ui.infoModal.style.display = 'none'; }

    // --- Event Listeners ---
    ui.tabsContainer.addEventListener('click', (e) => { if (e.target.matches('.tab-button')) showTab(e.target.dataset.tab); });
    ui.modalCloseButton.addEventListener('click', hideInfoModal);
    ui.infoModal.addEventListener('click', (e) => { if(e.target === ui.infoModal) hideInfoModal(); });
    ui.fileInput.addEventListener('change', loadFileAndAnalyze);
    ui.analyzeButton.addEventListener('click', () => analyzeHTML());
    ui.copyButton.addEventListener('click', () => copyCode('correctedHtmlOutput'));
    ui.iconUpload.addEventListener('change', handleIconUpload);
    ui.generateFooter.addEventListener('change', toggleFooterFields);
    ui.generateButton.addEventListener('click', generatePWA);
    ui.downloadButton.addEventListener('click', downloadZip);
    ui.templateMinimal.addEventListener('click', () => loadTemplate('minimal'));
    ui.templateTodo.addEventListener('click', () => loadTemplate('todo'));
    ui.generateIconButton.addEventListener('click', generateAndPreviewIcon);
    ui.addPushNotifications.addEventListener('change', (e) => { ui.vapidKeyContainer.style.display = e.target.checked ? 'block' : 'none'; });
    ui.addShareTarget.addEventListener('change', (e) => { ui.shareTargetFields.style.display = e.target.checked ? 'block' : 'none'; });
    ui.darkModeToggle.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });
    ui.themeColor.addEventListener('input', (e) => { document.querySelector('header').style.background = e.target.value; });
    ui.prevBtn.addEventListener('click', () => navigateWizard(-1));
    ui.nextBtn.addEventListener('click', () => navigateWizard(1));
    ui.checkPwaButton.addEventListener('click', checkPwa);

    // --- Tab Scroll Indicator ---
    ui.tabsContainer.addEventListener('scroll', () => {
        const { scrollLeft, scrollWidth, clientWidth } = ui.tabsContainer;
        ui.scrollIndicator.classList.toggle('visible', scrollLeft + clientWidth < scrollWidth - 10);
    }, { passive: true });

    window.addEventListener('resize', () => {
         const { scrollWidth, clientWidth } = ui.tabsContainer;
         ui.scrollIndicator.classList.toggle('visible', scrollWidth > clientWidth);
    });

    loadSavedValues();
    showTab('tutorial');
    initNetworkStatus();
    window.dispatchEvent(new Event('resize'));
    updateWizardView();

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabId)?.classList.add('active');
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
        if (tabId !== 'generate') {
            document.querySelector('header').style.background = '';
        } else {
            document.querySelector('header').style.background = ui.themeColor.value;
        }
    }

    function toggleFooterFields() { ui.footerFields.style.display = ui.generateFooter.checked ? 'block' : 'none'; }

    function handleIconUpload(e) {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => { uploadedIconBase64 = e.target.result; ui.iconPreview.src = uploadedIconBase64; ui.iconPreview.style.display = 'block'; };
        reader.readAsDataURL(file);
    }

    function loadFileAndAnalyze() {
        const file = ui.fileInput.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => { ui.htmlInput.value = e.target.result; analyzeHTML(e.target.result); };
        reader.readAsText(file);
    }

// --- analyzeHTML (KORRIGIERTE VERSION MIT WARNUNGEN & TRAILING CONTENT CHECK) ---
function analyzeHTML(inputHtmlOverride = null) {
 const inputHtml = inputHtmlOverride || ui.htmlInput.value;
ui.supabaseSuggestionContainer.style.display = 'none';
ui.supabaseSuggestionContainer.innerHTML = '';
pwaArtifacts.suggestedTableName = 'app_data'; // Reset Fallback
pwaArtifacts.detectedColumns = []; // Reset Spalten
if (!inputHtml.trim()) {
    alert('Bitte geben Sie HTML-Code ein oder laden Sie eine Datei hoch!');
    return;
}

let results = [];
let correctedHtml = inputHtml;
const doc = new DOMParser().parseFromString(inputHtml, 'text/html');

const titleMatch = doc.querySelector('title');
if (titleMatch && titleMatch.textContent) {
    ui.appName.value = titleMatch.textContent.trim();
    results.push('<p><strong class="ok">✓ Titel-Tag:</strong> Gefunden und als App-Name übernommen.</p>');
} else {
    results.push('<p><strong class="fail">✗ Titel-Tag:</strong> Fehlt. Wichtig für den App-Namen.</p>');
}

if (!doc.querySelector('meta[name="viewport"]')) {
    correctedHtml = correctedHtml.replace(/<head>/i, '$&\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">');
    results.push('<p><strong class="ok">✓ Viewport-Tag:</strong> Hinzugefügt für mobile Darstellung.</p>');
}

// --- KORREKTUR: Warnung bei vorhandenem Manifest ---
if (!doc.querySelector('link[rel="manifest"]')) {
     results.push('<p><strong class="fail">✗ Manifest-Link:</strong> Fehlt (wird in der generierten App dynamisch hinzugefügt).</p>');
} else {
     results.push('<p><strong class="ok">✓ Manifest-Link:</strong> Vorhanden. <span style="color: #d97706;">(Hinweis: Wird bei der Generierung überschrieben)</span></p>');
}

// --- KORREKTUR: Warnung bei vorhandener SW-Registrierung ---
if (!/navigator\.serviceWorker\.register/.test(correctedHtml)) {
     results.push('<p><strong class="fail">✗ Service Worker:</strong> Registrierung fehlt (wird in der generierten App dynamisch hinzugefügt).</p>');
} else {
     results.push('<p><strong class="ok">✓ Service Worker:</strong> Registrierung vorhanden. <span style="color: #d97706;">(Hinweis: Wird bei der Generierung überschrieben)</span></p>');
}

const assets = [...doc.querySelectorAll('link[rel="stylesheet"][href], script[src]')]
    .map(el => el.getAttribute('href') || el.getAttribute('src'))
    .filter(path => path && !path.startsWith('http') && !path.startsWith('//')); // '//' hinzugefügt für protokoll-relative URLs

if (assets.length > 0) {
    ui.extraFiles.value = assets.join(', ');
    results.push(`<p><strong class="ok">✓ Lokale Assets:</strong> <code>${assets.join(', ')}</code> erkannt und für Caching vorgemerkt.</p>`);
}
 
// --- KORREKTUR: Prüfung auf Inhalt nach </html> ---
 const closingHtmlIndex = correctedHtml.toLowerCase().lastIndexOf('</html>');
 if (closingHtmlIndex !== -1) {
     const trailingContent = correctedHtml.substring(closingHtmlIndex + '</html>'.length).trim();
     if (trailingContent) {
         results.push('<p><strong class="fail">✗ Inhalt nach &lt;/html&gt;:</strong> Es wurde Inhalt nach dem schließenden HTML-Tag gefunden. Dies kann zu Anzeigefehlern führen. Bitte entfernen Sie diesen Inhalt.</p>');
     } else {
         results.push('<p><strong class="ok">✓ Kein Inhalt nach &lt;/html&gt;:</strong> Korrekt.</p>');
     }
 } else {
     results.push('<p><strong class="fail">✗ Schließendes &lt;/html&gt;-Tag:</strong> Nicht gefunden. Das HTML-Dokument scheint unvollständig zu sein.</p>');
 }
 // --- Ende Prüfung ---

correctedHtmlForZip = correctedHtml;

// --- Versuch, das Ergebnis sicher zu rendern ---
try {
    ui.analysisOutput.innerHTML = `<h4>Analyse-Ergebnisse:</h4>${results.join('')}`;
} catch (e) {
    console.error("Fehler beim Rendern der Analyseergebnisse:", e);
    ui.analysisOutput.innerHTML = `<h4>Fehler bei der Analyse-Anzeige</h4><p>Ein interner Fehler ist aufgetreten. Überprüfe die Browser-Konsole.</p>`;
}
// --- Ende Rendering-Versuch ---

ui.analysisOutput.style.display = 'block';
ui.correctedHtmlOutput.value = correctedHtml;
ui.correctionContainer.style.display = 'block';

const inputs = doc.querySelectorAll('input[id][type="text"], input[id][type="number"], input[id][type="email"], textarea[id]');
if (inputs.length > 0) {
    const rawTableName = titleMatch ? titleMatch.textContent.trim() : 'app_data';
    const sanitizedTableName = rawTableName.toLowerCase().replace(/[^a-z0-9_]+/g, '_').replace(/^_|_$/g, '');
    pwaArtifacts.suggestedTableName = sanitizedTableName; // Tabellenname speichern

    let detectedColumns = [];
    inputs.forEach(input => {
        const colName = input.id.replace(/-/g, '_');
        const dataType = input.type === 'number' ? 'int8' : 'text'; // Vereinfacht
        const safeTag = input.outerHTML.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        // Speichere Spaltenname, Typ, Original-HTML-ID und das Tag selbst
        detectedColumns.push({name: colName, type: dataType, originalId: input.id, tag: safeTag}); 
    });
    pwaArtifacts.detectedColumns = detectedColumns; // Spalten speichern

    ui.supabaseSuggestionContainer.innerHTML = generateSupabaseSuggestionHtml(sanitizedTableName, detectedColumns);
    ui.supabaseSuggestionContainer.style.display = 'block';

    setTimeout(() => {
        document.getElementById('copySqlButton')?.addEventListener('click', () => copySqlToClipboard(sanitizedTableName, detectedColumns));
        ui.supabaseSuggestionContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}
}


    // --- START: Supabase Code Generierung (Option 3) ---
    
    /**
     * Generiert eine spezifische addItem Funktion basierend auf erkannten Spalten.
     */
    function generateSpecificAddItemFunction(tableName, columns) {
        // Erstellt Zeilen wie: const task_name = document.getElementById('task-name')?.value;
        const valueLookups = columns.map(col => `  const ${col.name} = document.getElementById('${col.originalId}')?.value;`).join('\n');
        
        // Erstellt Zeilen wie: task_name: task_name,
        const dataObjectFields = columns.map(col => `    ${col.name}: ${col.name}`).join(',\n');
        
        // Finde eine "Haupt"-Spalte (z.B. die erste Textspalte) für die Validierung
        const mainColumn = columns.find(col => col.type === 'text') || columns[0];
        const mainColumnValidation = mainColumn ? `if (!${mainColumn.name}) {
  alert('Bitte fülle zumindest das Feld "${mainColumn.name.replace(/_/g, ' ')}" aus.');
  return;
  }` : '';

        return `
/**
 * Fügt einen neuen Eintrag hinzu, basierend auf den Feldern deiner HTML.
 * Generiert am: ${new Date().toLocaleString()}
 */
async function addItem() {
  console.log('Versuche, neuen Eintrag hinzuzufügen...');
  
  // Werte aus den HTML-Input-Feldern lesen:
${valueLookups}

  // --- TODO: Grundlegende Validierung (passe dies an!) ---
  ${mainColumnValidation}
  // ---------------------------------------------------

  // Objekt für Supabase zusammenstellen:
  const newItem = { 
${dataObjectFields}
// --- TODO: Füge hier ggf. Standardwerte oder Nutzer-ID hinzu ---
// is_complete: false, // Beispiel
// user_id: supabase.auth.user()?.id // Beispiel für Auth
  };

  console.log('Zu speichernde Daten:', newItem);

  try {
const { data, error } = await supabase
  .from('${tableName}')
  .insert([newItem])
  .select();

if (error) throw error; // Fehler an catch übergeben

console.log('Eintrag hinzugefügt:', data);
alert('Eintrag erfolgreich hinzugefügt!');

// --- TODO: Optional: Formular leeren und/oder Liste neu laden ---
// Beispiel: document.getElementById('dein-formular-id').reset(); 
loadItems(); // Liste neu laden, um den neuen Eintrag anzuzeigen
// --------------------------------------------------------

  } catch (error) {
console.error('Fehler beim Hinzufügen:', error.message);
alert('Fehler beim Hinzufügen: ' + error.message);
  }
}

// --- TODO: Füge einen Event Listener hinzu, um addItem aufzurufen ---
// Beispiel: document.getElementById('add-button-id')?.addEventListener('click', addItem);
// -------------------------------------------------------------
`;
    }

    /**
     * Generiert eine loadItems Funktion mit spezifischen Kommentaren basierend auf erkannten Spalten.
     */
    function generateSpecificLoadItemsFunction(tableName, columns) {
        // Erstellt Beispiel-Code für die Anzeige in der Liste
        const displayExample = columns.map(col => `\${item.${col.name} || '-'}`).join(' | '); // Zeigt alle Spalten getrennt durch '|'

        return `
/**
 * Lädt alle Einträge aus der Tabelle "${tableName}".
 * Generiert am: ${new Date().toLocaleString()}
 */
async function loadItems() {
  console.log('Lade Einträge...');
  try {
const { data, error } = await supabase
  .from('${tableName}')
  .select('*')
  // --- TODO: Optional: Filtere die Daten, z.B. nach Nutzer ---
  // .eq('user_id', supabase.auth.user()?.id) 
  .order('created_at', { ascending: false }); // Neueste zuerst

if (error) throw error; // Fehler an catch übergeben

console.log('Geladene Einträge:', data);
alert(\`\${data.length} Einträge geladen. Siehe Konsole.\`);

// --- TODO: Zeige die 'data' (Array von Objekten) in deiner HTML an ---
// Beispiel: Eine Liste (<ul id="item-list">) aktualisieren:
/*
const itemList = document.getElementById('item-list'); 
if (itemList) {
    itemList.innerHTML = data.map(item => \`
        <li>
            <span>${displayExample}</span> 
            <button onclick="deleteItem('\${item.id}')">🗑️</button>
            // Optional: Button zum Bearbeiten hinzufügen (siehe updateItem)
            // <button onclick="promptUpdateItem('\${item.id}', item)">✏️</button> 
        </li>
    \`).join('');
}
*/
// -------------------------------------------------------------------

  } catch (error) {
console.error('Fehler beim Laden:', error.message);
alert('Fehler beim Laden: ' + error.message);
  }
}

// --- TODO: Rufe loadItems auf, wenn die App startet ---
// Beispiel: document.addEventListener('DOMContentLoaded', loadItems);
// ---------------------------------------------------
`;
    }
    
    /**
     * Generiert generische CRUD-Funktionen als Fallback.
     * (Wird verwendet, wenn Supabase aktiviert ist, aber keine Inputs erkannt wurden)
     */
    function generateGenericCrudFunctionSnippets(tableName) {
        return `
// --- Generische CRUD-Vorlagen (keine Inputs erkannt) ---

async function addItem() {
  // TODO: Hole Daten, z.B. aus einem Formular
  const name = prompt('Namen eingeben:');
  if (!name) return;

  try {
const { data, error } = await supabase
  .from('${tableName}')
  .insert([{ name: name /* TODO: Weitere Felder hier */ }])
  .select();
if (error) throw error;
console.log('Eintrag hinzugefügt:', data);
alert('Eintrag hinzugefügt!');
loadItems();
  } catch (error) {
console.error('Fehler beim Hinzufügen:', error.message);
  }
}

async function loadItems() {
  try {
const { data, error } = await supabase
  .from('${tableName}')
  .select('*')
  .order('created_at', { ascending: false });
if (error) throw error;
console.log('Geladene Einträge:', data);
alert(data.length + ' Einträge geladen (siehe Konsole).');

// TODO: Daten in der HTML anzeigen
// const list = document.getElementById('item-list');
// if (list) list.innerHTML = data.map(item => \`<li>\${item.name} <button onclick="deleteItem('\${item.id}')">X</button></li>\`).join('');

  } catch (error) {
console.error('Fehler beim Laden:', error.message);
  }
}
`;
    }


    /**
     * Generiert generische Update- und Delete-Funktionen.
     */
    function generateGenericUpdateDeleteFunctions(tableName) {
        return `
/**
 * Aktualisiert einen bestehenden Eintrag anhand seiner ID.
 * @param {string} id - Die UUID des zu aktualisierenden Eintrags.
 * @param {object} updatedData - Ein Objekt mit den Spaltennamen und neuen Werten.
 * Z.B. { name: 'Neuer Name', is_complete: true }
 */
async function updateItem(id, updatedData) {
  // --- TODO: Validierung hinzufügen? Prüfen, ob updatedData nicht leer ist? ---
  if (!id || !updatedData || Object.keys(updatedData).length === 0) {
  alert('Ungültige Daten für Update.');
  return;
  }
  // -----------------------------------------------------------------------

  console.log(\`Aktualisiere Eintrag \${id}...\`, updatedData);
  try {
const { data, error } = await supabase
  .from('${tableName}')
  .update(updatedData)
  .eq('id', id)
  .select();

if (error) throw error;

console.log('Eintrag aktualisiert:', data);
alert('Eintrag erfolgreich aktualisiert!');
loadItems(); // Liste neu laden
  } catch (error) {
console.error('Fehler beim Aktualisieren:', error.message);
alert('Fehler beim Aktualisieren: ' + error.message);
  }
}

/**
 * Löscht einen Eintrag anhand seiner ID.
 * @param {string} id - Die UUID des zu löschenden Eintrags.
 */
async function deleteItem(id) {
  if (!id) {
  alert('Ungültige ID zum Löschen.');
  return;
  }
  
  // Sicherheitsabfrage
  if (!confirm(\`Willst du den Eintrag wirklich löschen?\`)) {
  return;
  }
  
  console.log(\`Lösche Eintrag \${id}...\`);
  try {
const { error } = await supabase
  .from('${tableName}')
  .delete()
  .eq('id', id);

if (error) throw error;

console.log('Eintrag gelöscht');
alert('Eintrag erfolgreich gelöscht!');
loadItems(); // Liste neu laden
  } catch (error) {
console.error('Fehler beim Löschen:', error.message);
alert('Fehler beim Löschen: ' + error.message);
  }
}

// --- TODO: Hilfsfunktionen oder Event Listener für Update/Delete hinzufügen ---
// Beispiel für eine Update-Aufforderung (kann in loadItems's map verwendet werden):
/*
function promptUpdateItem(id, currentItem) {
// Beispiel: Nur den Namen ändern
const newName = prompt('Neuen Namen eingeben:', currentItem.name || ''); 
if (newName !== null && newName !== currentItem.name) {
    updateItem(id, { name: newName }); // Nur die Spalte 'name' aktualisieren
}
// Füge hier Logik für andere Felder hinzu, falls nötig
}
*/
// -------------------------------------------------------------------------
`;
    }

    // --- generateSupabaseSuggestionHtml: Angepasst, zeigt keine Snippets mehr ---
    function generateSupabaseSuggestionHtml(tableName, columns) {
         let detectedRowsHtml = columns.map(col => `
            <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 12px 15px; font-weight: 500;"><code>${col.name}</code></td>
                <td style="padding: 12px 15px;"><code>${col.type}</code></td>
                <td style="padding: 12px 15px; font-size: 0.9rem;">✔️ <strong>Automatisch erkannt</strong> aus <code>${col.tag}</code>.</td>
            </tr>`).join('');

        const nameHint = columns.length > 0 ? `Der Name wurde vom <code>&lt;title&gt;</code>-Tag Ihrer HTML abgeleitet (oder ist '${tableName}', falls kein Titel vorhanden war) und bereinigt. <strong>Sie können diesen Namen in Supabase ändern!</strong>` : '';

        // --- KEINE CODE SNIPPETS MEHR HIER ---

        return `
            <h4 style="font-size: 1.2rem; display: flex; align-items: center; margin-bottom: 0;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 10px;"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                Vorschlag für Supabase-Tabelle:
            </h4>
            <div class="table-name-display"><code>${tableName}</code></div>
            <p style="font-size: 0.9rem; margin-top: 10px; line-height: 1.5;">Basierend auf deiner HTML-Datei haben wir diese Tabellenstruktur generiert. ${nameHint} Wenn du Supabase im Generator aktivierst, werden spezifische JavaScript-Funktionen (<code>addItem</code>, <code>loadItems</code>, <code>updateItem</code>, <code>deleteItem</code>) basierend auf den erkannten Feldern automatisch zur <code>app.js</code> hinzugefügt.</p>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <h5>Anleitung (SQL):</h5>
                <ol style="font-size: 0.9rem; margin-left: 20px; line-height: 1.6;">
                    <li>Gehen Sie zu Ihrem Supabase-Projekt und klicken Sie auf den <strong>Table Editor</strong> oder <strong>SQL Editor</strong>.</li>
                    <li>Klicken Sie auf <strong>"Create a new table"</strong> oder fügen Sie den SQL-Befehl ein.</li>
                    <li>Nutzen Sie die untere Tabelle als Vorlage oder <strong>kopieren Sie direkt den SQL-Befehl</strong>.</li>
                </ol>
            </div>
            <div style="overflow-x: auto; margin-top: 1.5rem;">
                <table style="width: 100%; border-collapse: collapse; text-align: left; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                     <thead style="background-color: rgba(127, 255, 212, 0.2);">
                        <tr>
                            <th style="padding: 12px 15px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Spaltenname</th>
                            <th style="padding: 12px 15px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Supabase-Typ</th>
                            <th style="padding: 12px 15px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Beschreibung & Hinweise</th>
                        </tr>
                    </thead>
                    <tbody style="background-color: var(--card-background);">
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 12px 15px; font-weight: 500;"><code>id</code></td>
                            <td style="padding: 12px 15px;"><code>uuid</code></td>
                            <td style="padding: 12px 15px; font-size: 0.9rem;">⭐ <strong>Primärschlüssel</strong>. Eindeutige ID für jeden Eintrag.</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 12px 15px; font-weight: 500;"><code>created_at</code></td>
                            <td style="padding: 12px 15px;"><code>timestamptz</code></td>
                            <td style="padding: 12px 15px; font-size: 0.9rem;">⏱️ Zeitstempel der Erstellung (wird automatisch gesetzt).</td>
                        </tr>
                        ${detectedRowsHtml}
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 12px 15px; font-weight: 500;"><code>is_complete</code></td>
                            <td style="padding: 12px 15px;"><code>boolean</code></td>
                            <td style="padding: 12px 15px; font-size: 0.9rem;">💡 Empfehlung: Um den Status (erledigt/offen) zu speichern.</td>
                        </tr>
                        <tr>
                            <td style="padding: 12px 15px; font-weight: 500;"><code>user_id</code></td>
                            <td style="padding: 12px 15px;"><code>uuid</code></td>
                            <td style="padding: 12px 15px; font-size: 0.9rem;">💡 Empfehlung: Um die Aufgabe einem Benutzer zuzuordnen (benötigt Supabase Auth).</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button id="copySqlButton" class="copy-btn" style="width: auto; padding: 10px 15px; font-size: 0.95rem;">📋 SQL-Befehl kopieren</button>
        `;
    }
    
    // --- copySqlToClipboard bleibt unverändert ---
    function copySqlToClipboard(tableName, columns) {
        let columnDefs = columns.map(c => `  ${c.name} ${c.type}`).join(',\n');
        let sql = `CREATE TABLE ${tableName} (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  created_at timestamptz DEFAULT now() NOT NULL`;
         if (columns.length > 0) {
             sql += `,\n${columnDefs}`;
         }
         if (!columns.some(c => c.name === 'is_complete')) {
              sql += `,\n  is_complete boolean DEFAULT false`;
         }
          if (!columns.some(c => c.name === 'user_id')) {
              sql += `,\n  user_id uuid REFERENCES auth.users(id)`; 
         }
        sql += `\n);\n\n-- Richtlinien für Row Level Security (RLS) - WICHTIG für Sicherheit:\nALTER TABLE ${tableName} ENABLE ROW LEVEL SECURITY;\n\n-- Beispiel: Nutzer dürfen nur eigene Einträge sehen (wenn user_id Spalte existiert):\n-- CREATE POLICY "Allow individual read access" ON ${tableName} FOR SELECT USING (auth.uid() = user_id);\n\n-- Beispiel: Nutzer dürfen nur eigene Einträge erstellen:\n-- CREATE POLICY "Allow individual insert access" ON ${tableName} FOR INSERT WITH CHECK (auth.uid() = user_id);`;

        navigator.clipboard.writeText(sql).then(() => alert('SQL-Befehl inkl. RLS-Hinweisen in die Zwischenablage kopiert!'));
    }

    // --- copyCodeSnippet bleibt unverändert ---
    function copyCodeSnippet(elementId) {
        const codeElement = document.getElementById(elementId);
        if (codeElement) {
            navigator.clipboard.writeText(codeElement.textContent || codeElement.innerText)
                .then(() => alert('Code-Snippet kopiert!'))
                .catch(err => console.error('Fehler beim Kopieren des Snippets:', err));
        }
    }
    // --- ENDE: Supabase Code Generierung ---


    // --- START: generatePWA (KORRIGIERTE VERSION) ---
    async function generatePWA() {
        const v = {
            user: ui.githubUser.value.trim(), repo: ui.repoName.value.trim().replace(/\s+/g, '-'), app: ui.appName.value.trim(), shortApp: ui.appShortName.value.trim() || ui.appName.value.trim(),
            desc: ui.appDesc.value.trim(), theme: ui.themeColor.value, ver: ui.cacheVersion.value.trim(), strategy: ui.swStrategy.value, extras: ui.extraFiles.value.split(',').map(f => f.trim()).filter(f => f),
            maskable: ui.generateMaskableIcon.checked,
            backgroundSync: ui.addBackgroundSync.checked,
            shareTarget: ui.addShareTarget.checked,
            shareAction: ui.shareTargetAction.value.trim()
        };
        if (!v.user || !v.repo || !v.app || !uploadedIconBase64) return alert('Bitte alle Felder ausfüllen & Icon hochladen/generieren.');

        //--- KORREKTUR: startUrl basiert jetzt auf dem Repo-Namen ---
        const startUrl = `/${v.repo}/`; 
        
        const manifestObject = {
            name: v.app, short_name: v.shortApp, start_url: startUrl, display: "standalone",
            description: v.desc, background_color: "#ffffff", theme_color: v.theme
        };

        manifestObject.icons = [
            { src: "icons/icon-192x192.png", sizes: "192x192", type: "image/png", purpose: "any" },
            { src: "icons/icon-512x512.png", sizes: "512x512", type: "image/png", purpose: "any" }
        ];
        if (v.maskable) {
            manifestObject.icons.push({ src: "icons/icon-maskable-512x512.png", sizes: "512x512", type: "image/png", purpose: "maskable" });
        }

        if (v.shareTarget && v.shareAction) {
            //--- KORREKTUR: Share-Target-Aktion verwendet ebenfalls den korrekten Pfad ---
            manifestObject.share_target = { action: startUrl.slice(0, -1) + v.shareAction, method: "GET", params: { title: "title", text: "text", url: "url" } };
            
            // --- KORREKTUR: Das shareReceiverHtml benötigt jetzt den korrigierten SW-Registrierungscode ---
            const repoPath = `/${v.repo}/`;
            
            // KORREKTUR: <script> escapen (Fix für Meta-Workflow)
            const shareSWCode = `
  <script>
if ('serviceWorker' in navigator) {
  const repoPath = '${repoPath}';
  navigator.serviceWorker.register('./sw.js', { scope: repoPath })
    .then(() => console.log('Service Worker registered:', repoPath))
    .catch(err => console.error('SW registration failed:', err));
}
  <\/sc` + `ript>`;
            
            // KORREKTUR: <script> für FAB escapen (Fix für Meta-Workflow)
            const shareFabScript = `
<script>
  let deferredPrompt;
  const installButton = document.getElementById('installFab');
  window.addEventListener('beforeinstallprompt', (e) => {
e.preventDefault();
deferredPrompt = e;
if (installButton) {
  installButton.style.display = 'flex';
}
  });
  if (installButton) {
installButton.addEventListener('click', async () => {
  installButton.style.display = 'none';
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log('User choice:', outcome);
    deferredPrompt = null;
  }
});
  }
  window.addEventListener('appinstalled', () => {
 if (installButton) {
    installButton.style.display = 'none';
 }
deferredPrompt = null;
console.log('PWA wurde installiert');
  });
<\/sc` + `ript>`;

            // KORREKTUR: <script> für URL-Parameter escapen (Fix für Meta-Workflow)
            pwaArtifacts.shareReceiverHtml = `<!DOCTYPE html><html><head><title>Empfangene Daten</title><link rel="manifest" href="./manifest.json"></head><body><h1>Geteilte Inhalte:</h1><script>const p=new URLSearchParams(window.location.search);document.body.innerHTML+='<p><b>Titel:</b> '+(p.get('title')||'N/A')+'</p><p><b>Text:</b> '+(p.get('text')||'N/A')+'</p><p><b>URL:</b> '+(p.get('url')||'N/A')+'</p>';<\/sc`+`ript>
  ${shareSWCode}
<button id="installFab" title="App installieren" style="display: none; position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; background-color: #1e40af; color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 1000; justify-content: center; align-items: center;">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
</button>
${shareFabScript}</body></html>`;
        }
        pwaArtifacts.manifest = JSON.stringify(manifestObject, null, 2);
        
        // Korrigierte Caching-Pfade:
        // Der SW registriert sich mit scope '/repo/'. 
        // Ein Request nach '/repo/index.html' wird vom SW als './index.html' gesehen.
        // Daher müssen die Pfade *innerhalb* des SW relativ sein.
        
        const relativeAssetsToCache = [
            './', // Cache den Scope-Root
            './index.html',
            './manifest.json',
            './offline.html',
            './icons/icon-192x192.png',
            './icons/icon-512x512.png'
        ];


        if (v.maskable) {
            relativeAssetsToCache.push('./icons/icon-maskable-512x512.png');
        }

        if(v.extras.length > 0) {
             relativeAssetsToCache.push(...v.extras.map(f => `./${f}`));
        }
        if (ui.addSupabase.checked) {
            relativeAssetsToCache.push('./supabaseClient.js');
        }
        let willGenerateAppJs = ui.addSupabase.checked || ui.addPushNotifications.checked || v.backgroundSync;
        if (willGenerateAppJs) {
             relativeAssetsToCache.push('./app.js');
        }
        // ------------------------------------

        const assets = JSON.stringify(relativeAssetsToCache);
        const offlineUrl = './offline.html'; // Offline-URL muss auch relativ sein
        const fetchHandler = v.strategy === 'network-first' ? `fetch(e.request).catch(() => caches.match("${offlineUrl}"))` : `caches.match(e.request).then(r => r || fetch(e.request)).catch(() => caches.match("${offlineUrl}"))`;
        let swContent = `const CN='pwa-cache-${v.ver}';const URLS=${assets};self.addEventListener('install',e=>e.waitUntil(caches.open(CN).then(c=>c.addAll(URLS))));self.addEventListener('fetch',e=>e.respondWith(${fetchHandler}));`;
        pwaArtifacts.offlineHtml = `<!DOCTYPE html><html><head><title>Offline</title><meta name="viewport" content="width=device-width, initial-scale=1.0"></head><body style="font-family: sans-serif; text-align: center; padding: 2rem;"><h1>Offline</h1><p>Du bist momentan nicht mit dem Internet verbunden.</p></body></html>`;

        try {
            const iconPromises = [scaleIcon(uploadedIconBase64, 192, false), scaleIcon(uploadedIconBase64, 512, false)];
            if (v.maskable) { iconPromises.push(scaleIcon(uploadedIconBase64, 512, true)); }
            const [icon192, icon512, maskableIcon512] = await Promise.all(iconPromises);
            pwaArtifacts.icon192 = icon192; pwaArtifacts.icon512 = icon512; pwaArtifacts.maskableIcon512 = maskableIcon512 || null;
        } catch (e) { return alert('Fehler beim Skalieren des Icons.'); }

        let appJsContent = ''; 
        let needsAppJs = false; 

        // --- Supabase Integration (Option 3) ---
        if (ui.addSupabase.checked) {
            needsAppJs = true; 
            pwaArtifacts.supabaseClient = `import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';\nexport const supabase = createClient('__SUPABASE_URL__', '__SUPABASE_ANON_KEY__');`;
            appJsContent += `import { supabase } from './supabaseClient.js'; console.log('Supabase client loaded!');\n\n`;
            
            const tableName = pwaArtifacts.suggestedTableName || 'app_data';
            const columns = pwaArtifacts.detectedColumns || [];

            if (columns.length > 0) {
                // Generiere spezifische Funktionen, wenn Spalten erkannt wurden
                appJsContent += generateSpecificAddItemFunction(tableName, columns);
                appJsContent += '\n\n' + generateSpecificLoadItemsFunction(tableName, columns);
            } else {
                // Fallback auf generische CRUD-Funktionen, wenn keine Inputs erkannt wurden
                 appJsContent += `// Keine Input-Felder in der HTML gefunden. Generische CRUD-Funktionen als Vorlage:\n`;
                 appJsContent += generateGenericCrudFunctionSnippets(tableName); // Verwende die alten generischen Vorlagen
            }
             // Generiere immer Update/Delete dazu (sind eh generisch)
             if (columns.length > 0) { // Füge sie nur hinzu, wenn spezifische add/load generiert wurden
                 appJsContent += '\n\n' + generateGenericUpdateDeleteFunctions(tableName);
             } else {
                 // Füge sie auch zum generischen Fallback hinzu
                 appJsContent += '\n\n' + generateGenericUpdateDeleteFunctions(tableName);
             }


            pwaArtifacts.githubWorkflow = `name: Deploy\non: {push: {branches: [main]}}\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v3\n      - run: sed -i "s|__SUPABASE_URL__|\\\${{ secrets.SUPABASE_URL }}|g; s|__SUPABASE_ANON_KEY__|\\\${{ secrets.SUPABASE_ANON_KEY }}|g" supabaseClient.js\n      - uses: JamesIves/github-pages-deploy-action@v4\n        with:\n          branch: gh-pages\n          folder: .`;
        } else { 
            pwaArtifacts.supabaseClient = null; 
            pwaArtifacts.githubWorkflow = null; 
        }
// --- Andere Erweiterte Funktionen ---
if (ui.addPushNotifications.checked) {
    needsAppJs = true;
    swContent += `\n\nself.addEventListener('push',e=>{const d=e.data.json();self.registration.showNotification(d.title,{body:d.body,icon:'icons/icon-192x192.png'})});`;
    const vapidKey = ui.vapidKeyInput.value.trim() || 'YOUR_PUBLIC_VAPID_KEY';
    // Füge Push-Code *nach* Supabase-Code ein, falls vorhanden
    appJsContent += `\n\n// --- Push Notification Code ---\nconsole.log('Push script active.'); const publicVapidKey = '${vapidKey}';\n`;
    
    // KORREKTUR: <script> escapen (auch wenn auskommentiert, zur Sicherheit) (Fix für Meta-Workflow)
    appJsContent += `
/* async function registerPush() {
  if (!('serviceWorker' in navigator)) return;
  try {
    const registration = await navigator.serviceWorker.ready;
    let subscription = await registration.pushManager.getSubscription();
    if (!subscription) {
      subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: publicVapidKey 
      });
    }
    console.log('Push Subscription:', subscription);
    // TODO: Sende das 'subscription' Objekt an deinen Backend-Server
  } catch (err) {
    console.error('Push registration failed:', err);
  }
}
// registerPush(); // Rufe dies auf, wenn der Nutzer Push erlaubt hat
*/\n`;
}
 if (v.backgroundSync) {
     needsAppJs = true;
    swContent += `\n\nself.addEventListener('sync', e => { if (e.tag === 'my-sync-tag') { e.waitUntil(console.log('Background Sync event fired! Implementiere hier die Logik.')); } });`;
    // Füge Sync-Code *nach* anderem Code ein
    appJsContent += `\n\n// --- Background Sync Code ---\nasync function registerBackgroundSync() { \n  if (!('serviceWorker' in navigator) || !('SyncManager' in window)) return; \n  try { \n    const registration = await navigator.serviceWorker.ready; \n    await registration.sync.register('my-sync-tag'); \n    console.log('Background Sync registered');\n  } catch (err) { \n    console.error('Background Sync registration failed:', err); \n  } \n}\n// registerBackgroundSync(); // Rufe dies auf, wenn eine Aktion offline ausgeführt werden soll\n`;
}

pwaArtifacts.sw = swContent;

if (needsAppJs && appJsContent) {
     pwaArtifacts.appJs = appJsContent.trim(); // Trimme Leerzeichen am Ende
} else {
     pwaArtifacts.appJs = null; 
}


ui.manifestOutput.value = pwaArtifacts.manifest;
ui.swOutput.value = pwaArtifacts.sw;
ui.outputSection.style.display = 'block';
ui.downloadButton.style.display = 'flex';
alert('Generierung erfolgreich! Spezifische Supabase-Funktionen wurden zu app.js hinzugefügt (falls Inputs erkannt wurden).');
saveSettings();
        }
        // --- ENDE: generatePWA ---


        // --- downloadZip: (KORRIGIERTE VERSION) ---
        async function downloadZip() {
if (!pwaArtifacts.manifest) return;
ui.downloadButton.disabled = true; ui.downloadButton.textContent = '...';

try {
    const zip = new JSZip();
    let html = correctedHtmlForZip || `<!DOCTYPE html><html><head><title>${ui.appName.value}</title></head><body></body></html>`;

    // --- KORREKTUR 1 & 4: Dynamisches Head-Skript entfernt ---
    // (ENTFERNT)
    
    // --- KORREKTUR 2: Repository-Pfad für SW Scope holen ---
    const repoName = ui.repoName.value.trim().replace(/\s+/g, '-') || 'my-pwa';
    const repoPath = `/${repoName}/`; // z.B. /my-awesome-pwa/

    // --- KORREKTUR 2: Statisches Body-Skript mit korrektem Scope ---
    // --- KORREKTUR 5: <script> MUSS escaped werden! (Fix für Meta-Workflow) ---
    const staticBodyScript = `
  <script>
    if ('serviceWorker' in navigator) {
      // KORREKTUR 2: Scope auf Repository-Pfad setzen
      const repoPath = '${repoPath}';
      navigator.serviceWorker.register('./sw.js', { scope: repoPath })
        .then((reg) => console.log('Service Worker registered:', reg.scope))
        .catch(err => console.error('SW registration failed:', err));
    }
  <\/sc` + `ript>`;

    // --- KORREKTUR 1: Statisches Manifest-Link einfügen ---
    html = html.replace('</head>', `  <link rel="manifest" href="./manifest.json">\n</head>`);
    
    // --- KORREKTUR 2: Neues SW-Skript einfügen ---
    html = html.replace('</body>', `${staticBodyScript}\n</body>`);

    const themeColor = ui.themeColor.value;
    if (html.includes('<meta name="theme-color"')) {
        // KORREKTUR 3: Dies war bereits korrekt
        html = html.replace(/<meta name="theme-color" content="[^"]*">/g, `<meta name="theme-color" content="${themeColor}">`); 
    } else {
        html = html.replace('</head>', `  <meta name="theme-color" content="${themeColor}">\n</head>`);
    }

    if (document.querySelector('input[name="userSelect"]:checked').value === 'disabled') {
        html = html.replace('</head>', `<style>body{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}</style>\n</head>`);
    }
     html = html.replace('</head>', `<style>input, textarea, code { user-select: text !important; -webkit-user-select: text !important; -moz-user-select: text !important; -ms-user-select: text !important; }</style>\n</head>`);

    if (ui.generateFooter.checked) {
        const footerHtml = `<footer style="text-align:center;padding:1.5rem;background-color:#1f2937;color:#d1d5db;font-size:0.75rem;"><p>${ui.footerLine1.value}</p><p>${ui.footerLine2.value}</p><p><a href="mailto:${ui.footerLine3.value}" style="color:#3b82f6;text-decoration:none;">${ui.footerLine3.value}</a></p></footer>`;
        html = html.replace(/<\/body>/i, `${footerHtml}\n$&`);
    }

    // --- app.js nur hinzufügen/verlinken, wenn sie existiert ---
    if (pwaArtifacts.appJs) { 
        // KORREKTUR 5: <script> escapen (Fix für Meta-Workflow)
        html = html.replace(/<\/body>/i, `<script type="module" src="app.js"><\/sc`+`ript>\n$&`);
        zip.file('app.js', pwaArtifacts.appJs);
    }
    // -----------------------------------------------------------
    
    if (pwaArtifacts.supabaseClient) {
        zip.file('supabaseClient.js', pwaArtifacts.supabaseClient);
        if (pwaArtifacts.githubWorkflow) {
            zip.folder('.github').folder('workflows').file('deploy.yml', pwaArtifacts.githubWorkflow);
        }
    }
    if (pwaArtifacts.shareReceiverHtml) {
        const actionPath = ui.shareTargetAction.value.trim().startsWith('/') ? ui.shareTargetAction.value.trim().substring(1) : ui.shareTargetAction.value.trim();
        zip.file(actionPath || 'receive-share.html', pwaArtifacts.shareReceiverHtml);
    }

    const fabHtml = `
<button id="installFab" title="App installieren" style="display: none; position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; background-color: ${themeColor}; color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 1000; justify-content: center; align-items: center;">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
</button>`;

    // --- KORREKTUR 5: <script> MUSS escaped werden! (Fix für Meta-Workflow) ---
    const fabScript = `
<script>
  let deferredPrompt;
  const installButton = document.getElementById('installFab');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (installButton) {
      installButton.style.display = 'flex';
    }
  });

  if (installButton) {
    installButton.addEventListener('click', async () => {
      installButton.style.display = 'none';
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log('User choice:', outcome);
        deferredPrompt = null;
      }
    });
  }

  window.addEventListener('appinstalled', () => {
     if (installButton) {
        installButton.style.display = 'none';
     }
    deferredPrompt = null;
    console.log('PWA wurde installiert');
  });
<\/sc` + `ript>`;

    html = html.replace('</body>', `${fabHtml}\n${fabScript}\n</body>`);

    zip.file('index.html', html);
    zip.file('manifest.json', pwaArtifacts.manifest);
    zip.file('sw.js', pwaArtifacts.sw);
    zip.file('offline.html', pwaArtifacts.offlineHtml);
    const iconsFolder = zip.folder('icons');
    iconsFolder.file('icon-192x192.png', pwaArtifacts.icon192, { base64: true });
    iconsFolder.file('icon-512x512.png', pwaArtifacts.icon512, { base64: true });
    if (pwaArtifacts.maskableIcon512) { iconsFolder.file('icon-maskable-512x512.png', pwaArtifacts.maskableIcon512, { base64: true }); }

    const blob = await zip.generateAsync({ type: 'blob' });
    saveAs(blob, 'pwa-files.zip');
} finally {
    ui.downloadButton.disabled = false; ui.downloadButton.textContent = '⬇️';
}
        }
        // --- ENDE: downloadZip ---


        // --- checkPwa (KORRIGIERTE VERSION) ---
        async function checkPwa() {
const url = ui.pwaUrlInput.value.trim();
if (!url || !url.startsWith('http')) {
    ui.checkResults.innerHTML = '<p class="fail">Bitte geben Sie eine gültige, vollständige URL ein (beginnend mit http/https).</p>';
    return;
}

ui.checkResults.innerHTML = `<ul>
    <li id="check-https"></li>
    <li id="check-manifest"></li>
    <li id="check-sw"></li>
    <li id="check-theme"></li>
</ul>
<p style="font-size: 0.8rem; color: var(--subtle-text); margin-top: 1rem;">Hinweis: Dies ist eine einfache Prüfung und ersetzt keinen vollständigen PWA-Audit (z.B. mit Lighthouse).</p>`;

const checkItem = async (id, text, checkFn) => {
    const li = document.getElementById(id);
    li.innerHTML = `<span class="spinner"></span> ${text}`;
    const { success, message } = await checkFn();
    li.innerHTML = `${success ? '✔️' : '❌'} ${text} ${message ? `(${message})` : ''}`;
};

checkItem('check-https', 'Verbindung ist sicher (HTTPS)', async () => ({ success: url.startsWith('https://') }));

let htmlContent = '';
try {
    const response = await fetch(url, { cache: 'no-cache', mode: 'cors' }); 
    if (!response.ok) throw new Error(`HTML nicht erreichbar: ${response.status}`);
    htmlContent = await response.text();
} catch (e) {
    ui.checkResults.innerHTML = `<p class="fail">Konnte die Haupt-URL nicht abrufen: ${e.message}.<br>Stellen Sie sicher, dass die URL korrekt ist und CORS-Anfragen erlaubt (oder führen Sie diesen Test von derselben Domain aus).</p>`;
    return;
}

checkItem('check-theme', 'Theme-Farbe im HTML gesetzt', async () => {
    const doc = new DOMParser().parseFromString(htmlContent, 'text/html');
    return { success: !!doc.querySelector('meta[name="theme-color"]') };
});

checkItem('check-manifest', 'Manifest & Icons sind gültig', async () => {
    const doc = new DOMParser().parseFromString(htmlContent, 'text/html');
    const manifestLink = doc.querySelector('link[rel="manifest"]');
    if (!manifestLink) return { success: false, message: 'Kein <link rel="manifest"> gefunden' };

    const manifestUrl = new URL(manifestLink.href, url);
    let manifest;
    try {
        const res = await fetch(manifestUrl, { cache: 'no-cache' });
        if (!res.ok) return { success: false, message: `Manifest-Fehler ${res.status}` };
        const text = await res.text();
        if (text.length === 0) return { success: false, message: 'Manifest-Datei ist leer' };
        manifest = JSON.parse(text); 
    } catch (e) { 
        return { success: false, message: 'Manifest nicht erreichbar/lesbar' }; 
    }

    if (!manifest.start_url) {
        return { success: false, message: 'Manifest: "start_url" fehlt' };
    }
    if (!manifest.icons || manifest.icons.length === 0) {
        return { success: false, message: 'Manifest: "icons"-Array fehlt' };
    }

    try {
        // Teste das erste Icon
        const iconSrc = manifest.icons[0].src;
        const iconUrl = new URL(iconSrc, manifestUrl);
        const iconRes = await fetch(iconUrl, { cache: 'no-cache', method: 'HEAD' }); 
        
        if (!iconRes.ok) {
            return { success: false, message: `Icon "${iconSrc}" nicht erreichbar (Fehler ${iconRes.status})` };
        }
        return { success: true, message: `Gefunden & Icon-Test OK` };
    } catch (e) {
        return { success: false, message: `Icon "${manifest.icons[0].src}" konnte nicht geladen werden` };
    }
});

checkItem('check-sw', 'Service Worker registriert & erreichbar', async () => {
    //--- KORREKTUR: Regex angepasst, um './sw.js' und den Scope zu finden ---
    const swRegex = /navigator\.serviceWorker\.register\(\s*['"](\.?\/?sw\.js)['"]\s*,\s*\{.*scope:\s*['"](.*?)['"].*\}\s*\)/;
    const match = htmlContent.match(swRegex);
    
    if (!match || !match[1] || !match[2]) {
         // Fallback für alte oder abweichende Registrierungen
         const altRegex = /navigator\.serviceWorker\.register\(\s*.*?['"](.*?sw\.js)['"].*?\)/;
         const altMatch = htmlContent.match(altRegex);
         if (altMatch && altMatch[1]) {
             return { success: false, message: `SW-Registrierung gefunden (${altMatch[1]}), aber der erwartete Scope fehlt.` };
         }
         return { success: false, message: 'Keine korrekte SW-Registrierung (./sw.js mit Scope) im HTML gefunden' };
    }


    const swPath = match[1]; // './sw.js'
    const swScope = match[2]; // '/repo/'
    
    // Der SW wird relativ zur HTML-URL geladen
    const swUrl = new URL(swPath, url); 

    try {
        const res = await fetch(swUrl, { cache: 'no-cache' });
        if (!res.ok) return { success: false, message: `Fehler ${res.status} bei ${swPath}` };
        const text = await res.text();
        if (text.length === 0) return { success: false, message: `${swPath} ist leer` };
        return { success: true, message: `Gefunden: ${swPath} (Scope: ${swScope})` };
    } catch (e) { return { success: false, message: `${swPath} nicht erreichbar` }; }
});
        }


        // --- Restliche Hilfsfunktionen bleiben unverändert ---
        function scaleIcon(base64, size, isMaskable = false) {
return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
        const canvas = document.createElement('canvas'); canvas.width = size; canvas.height = size;
        const ctx = canvas.getContext('2d');
        if (isMaskable) {
            const bgColor = ui.iconBgColor.value;
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, size, size);
            const iconSize = size * 0.8;
            const offset = (size - iconSize) / 2;
            ctx.drawImage(img, offset, offset, iconSize, iconSize);
        } else {
            ctx.drawImage(img, 0, 0, size, size);
        }
        resolve(canvas.toDataURL('image/png').split(',')[1]);
    };
    img.onerror = reject;
    img.src = base64;
});
        }

        function copyCode(id) { document.getElementById(id).select(); document.execCommand('copy'); alert('Kopiert!'); }

        function loadTemplate(templateName) {
if (templateName === 'minimal') { ui.htmlInput.value = `<!DOCTYPE html>\n<html lang="de">\n<head>\n    <meta charset="UTF-8">\n    <title>Minimale PWA</title>\n</head>\n<body>\n    <h1>Hallo Welt!</h1>\n</body>\n</html>`;
} else if (templateName === 'todo') { ui.htmlInput.value = `<!DOCTYPE html>\n<html lang="de">\n<head>\n    <meta charset="UTF-8">\n    <title>Todo App</title>\n</head>\n<body>\n    <h1>Todo App</h1>\n    <input type="text" id="new-todo" placeholder="Neue Aufgabe...">\n    <button id="add-btn">Add</button>\n    <ul id="todo-list"></ul>\n</body>\n</html>`; }
analyzeHTML();
        }

        function generatePlaceholderIcon(initials, bgColor) {
const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
const ctx = canvas.getContext('2d');
ctx.fillStyle = bgColor; ctx.fillRect(0, 0, 512, 512);
ctx.fillStyle = '#FFFFFF'; ctx.font = 'bold 200px sans-serif';
ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
ctx.fillText(initials.toUpperCase(), 256, 256);
return canvas.toDataURL('image/png');
        }

        function generateAndPreviewIcon() {
const initials = ui.iconInitials.value;
const bgColor = ui.iconBgColor.value;
if (!initials) return alert('Bitte Initialen eingeben.');
const generatedIcon = generatePlaceholderIcon(initials, bgColor);
uploadedIconBase64 = generatedIcon;
ui.iconPreview.src = generatedIcon;
ui.iconPreview.style.display = 'block';
        }

        function saveSettings() {
const settings = {
    githubUser: ui.githubUser.value, repoName: ui.repoName.value, appName: ui.appName.value, appShortName: ui.appShortName.value,
    appDesc: ui.appDesc.value, themeColor: ui.themeColor.value, swStrategy: ui.swStrategy.value, cacheVersion: ui.cacheVersion.value, extraFiles: ui.extraFiles.value,
    userSelect: document.querySelector('input[name="userSelect"]:checked').value, generateFooter: ui.generateFooter.checked,
    addSupabase: ui.addSupabase.checked, addPushNotifications: ui.addPushNotifications.checked, vapidKeyInput: ui.vapidKeyInput.value, addBackgroundSync: ui.addBackgroundSync.checked, addShareTarget: ui.addShareTarget.checked, shareTargetAction: ui.shareTargetAction.value,
    footerLine1: ui.footerLine1.value, footerLine2: ui.footerLine2.value, footerLine3: ui.footerLine3.value,
    iconInitials: ui.iconInitials.value, iconBgColor: ui.iconBgColor.value, generateMaskableIcon: ui.generateMaskableIcon.checked
};
localStorage.setItem('pwaStudioSettings', JSON.stringify(settings));
        }

        function loadSavedValues() {
const settings = JSON.parse(localStorage.getItem('pwaStudioSettings'));
if (!settings) return;
ui.githubUser.value = settings.githubUser || '';
ui.repoName.value = settings.repoName || '';
ui.appName.value = settings.appName || 'Meine PWA App';
ui.appShortName.value = settings.appShortName || 'PWA App';
ui.appDesc.value = settings.appDesc || '';
ui.themeColor.value = settings.themeColor || '#1e40af';
ui.swStrategy.value = settings.swStrategy || 'cache-first';
ui.cacheVersion.value = settings.cacheVersion || 'v1';
ui.extraFiles.value = settings.extraFiles || '';
const userSelectRadio = document.querySelector(`input[name="userSelect"][value="${settings.userSelect || 'disabled'}"]`);
if(userSelectRadio) userSelectRadio.checked = true;
ui.generateFooter.checked = settings.generateFooter || false;
ui.addSupabase.checked = settings.addSupabase || false;
ui.addPushNotifications.checked = settings.addPushNotifications || false;
ui.vapidKeyInput.value = settings.vapidKeyInput || '';
ui.vapidKeyContainer.style.display = ui.addPushNotifications.checked ? 'block' : 'none';
ui.addBackgroundSync.checked = settings.addBackgroundSync || false;
ui.addShareTarget.checked = settings.addShareTarget || false;
ui.shareTargetAction.value = settings.shareTargetAction || '/receive-share';
ui.shareTargetFields.style.display = ui.addShareTarget.checked ? 'block' : 'none';
toggleFooterFields();
ui.footerLine1.value = settings.footerLine1 || 'PWA Studio Pro © 2025 – Build • Analyze • Deploy';
ui.footerLine2.value = settings.footerLine2 || 'Entwickelt von Björn Voss aka Omega';
ui.footerLine3.value = settings.footerLine3 || 'voss.1980@gmail.com';

ui.iconInitials.value = settings.iconInitials || '';
ui.iconBgColor.value = settings.iconBgColor || '#3b82f6';
ui.generateMaskableIcon.checked = settings.generateMaskableIcon || false;

const savedTheme = localStorage.getItem('theme');
if (savedTheme) applyTheme(savedTheme);
else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) applyTheme('dark');
        }

function initNetworkStatus() {
    function updateStatus() {
        ui.networkStatus.className = navigator.onLine ? 'status-online' : 'status-offline';
        ui.networkStatus.textContent = 'PWA Studio Pro: ' + (navigator.onLine ? 'Online' : 'Offline');

        if (navigator.onLine && 'serviceWorker' in navigator) {
            
            // Berechne den Scope für das Studio selbst
            const pathSegments = window.location.pathname.split('/');
            if (pathSegments[pathSegments.length - 1].includes('.')) {
                pathSegments.pop();
            }
            let studioScope = pathSegments.join('/');
            if (!studioScope.endsWith('/')) {
                studioScope += '/';
            }
            if (studioScope === '//') {
                studioScope = '/';
            }
            
            // --- NEUE UPDATE-LOGIK ---
            navigator.serviceWorker.register('sw.js', { scope: studioScope })
                .then(registration => {
                    console.log('PWA-Studio Service Worker registriert.', registration.scope);

                    // 1. Prüfe auf ein wartendes Update (z.B. von einem vorherigen Tab)
                    if (registration.waiting) {
                        console.log('Neuer SW wartet, erzwinge Aktivierung...');
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    }

                    // 2. Horche auf zukünftige Updates
                    registration.onupdatefound = () => {
                        const newWorker = registration.installing;
                        console.log('Neuer SW gefunden, installiere...', newWorker);
                        
                        newWorker.onstatechange = () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // Neuer SW ist installiert, aber noch nicht aktiv
                                // Sende 'SKIP_WAITING', um ihn sofort zu aktivieren
                                console.log('Neuer SW installiert, sende SKIP_WAITING.');
                                newWorker.postMessage({ type: 'SKIP_WAITING' });
                            }
                        };
                    };
                })
                .catch(err => console.error('PWA-Studio SW-Registrierung fehlgeschlagen:', err));
            
            // 3. Seite neu laden, wenn der Controller (SW) wechselt
            let refreshing = false;
            navigator.serviceWorker.oncontrollerchange = () => {
                if (refreshing) return;
                console.log('Neuer SW ist aktiv! Lade Seite neu...');
                refreshing = true;
                window.location.reload();
            };
            // --- ENDE NEUE UPDATE-LOGIK ---
        }
    }
    window.addEventListener('online', updateStatus);
    window.addEventListener('offline', updateStatus);
    updateStatus();
}
function applyTheme(theme) {
    document.documentElement.classList.toggle('dark', theme === 'dark');
}

function navigateWizard(direction) {
    const newStep = currentWizardStep + direction;
    if (newStep < 1 || newStep > totalWizardSteps) return;
    currentWizardStep = newStep;
    updateWizardView();
}

function updateWizardView() {
    document.querySelectorAll('.wizard-step').forEach(step => step.classList.remove('active'));
    document.getElementById(`wizard-step-${currentWizardStep}`)?.classList.add('active');

    ui.prevBtn.style.display = currentWizardStep === 1 ? 'none' : 'block';
    ui.nextBtn.style.display = currentWizardStep === totalWizardSteps ? 'none' : 'block';
    ui.generateButton.style.display = currentWizardStep === totalWizardSteps ? 'block' : 'none';

    ui.wizardProgress.style.width = `${(currentWizardStep / totalWizardSteps) * 100}%`;
}
    });
  </script>
</body>
</html>